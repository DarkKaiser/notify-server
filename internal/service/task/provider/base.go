package provider

import (
	"context"
	"errors"
	"fmt"
	"sync"
	"sync/atomic"
	"time"

	"github.com/darkkaiser/notify-server/internal/service/contract"
	"github.com/darkkaiser/notify-server/internal/service/task/scraper"
	applog "github.com/darkkaiser/notify-server/pkg/log"
)

const (
	// notifyTaskExecutionFailed ìž‘ì—… ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ëª¨ë“  ì—ëŸ¬ ìƒí™©ì— ëŒ€í•´ ì‚¬ìš©ìžì—ê²Œ ì „ì†¡ë˜ëŠ” ì•Œë¦¼ ë©”ì‹œì§€ì˜ ê³µí†µ í—¤ë”ìž…ë‹ˆë‹¤.
	//
	// ì´ ë©”ì‹œì§€ ë’¤ì—ëŠ” í•­ìƒ êµ¬ì²´ì ì¸ ì—ëŸ¬ ì›ì¸(reason)ì´ ê²°í•©ë˜ì–´ ì „ì†¡ë˜ë¯€ë¡œ,
	// ì‚¬ìš©ìžê°€ ì–´ë–¤ ë¬¸ì œë¡œ ì‹¤íŒ¨í–ˆëŠ”ì§€ ì‰½ê²Œ íŒŒì•…í•  ìˆ˜ ìžˆë„ë¡ ë•ìŠµë‹ˆë‹¤.
	notifyTaskExecutionFailed = "ìž‘ì—… ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.ðŸ˜±"

	// notifySnapshotSaveFailedFormat ìž‘ì—… ì‹¤í–‰ ì™„ë£Œ í›„, ìƒˆë¡œìš´ ìž‘ì—… ê²°ê³¼(Snapshot)ë¥¼ Storageì— ì €ìž¥í•˜ëŠ” ê³¼ì •ì—ì„œ
	// ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ì„ ë•Œ ì‚¬ìš©ë˜ëŠ” ì•Œë¦¼ ë©”ì‹œì§€ í¬ë§·ìž…ë‹ˆë‹¤.
	//
	// ì´ ë©”ì‹œì§€ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ë°ì´í„° ì˜ì†í™”ì— ì‹¤íŒ¨í–ˆìŒì„ ì‚¬ìš©ìžì—ê²Œ ì•Œë¦½ë‹ˆë‹¤.
	notifySnapshotSaveFailedFormat = "ìž‘ì—… ì‹¤í–‰ì€ ì„±ê³µí•˜ì˜€ìœ¼ë‚˜, ê²°ê³¼ ë°ì´í„° ì €ìž¥ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.ðŸ˜±\n\nâ˜‘ %s"

	// notifySnapshotLoadFailedFormat ì´ì „ ìž‘ì—… ì‹¤í–‰ ê²°ê³¼(Snapshot)ë¥¼ Storageì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ê³¼ì •ì—ì„œ
	// ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œ ì‚¬ìš©ìžì—ê²Œ ì „ë‹¬ë˜ëŠ” ì•Œë¦¼ ë©”ì‹œì§€ í¬ë§·ìž…ë‹ˆë‹¤.
	//
	// ìž‘ì—… ì‹¤í–‰ì„ ìœ„í•œ ì´ˆê¸° ìƒíƒœ ë³µì›ì— ì‹¤íŒ¨í–ˆìŒì„ ì˜ë¯¸í•˜ë©°, ì£¼ë¡œ Storage ì—°ê²° ë¬¸ì œë‚˜ ë°ì´í„° ì†ìƒì´ ì›ì¸ìž…ë‹ˆë‹¤.
	notifySnapshotLoadFailedFormat = "ì´ì „ ìž‘ì—… ê²°ê³¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.ðŸ˜±\n\nâ˜‘ %s"

	// errMsgExecuteFuncNotInitialized Taskì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(ExecuteFunc)ì´
	// ì£¼ìž…ë˜ì§€ ì•Šì•˜ì„ ë•Œ ë°œìƒí•˜ëŠ” ê°œë°œìž ëŒ€ìƒ ì—ëŸ¬ ë©”ì‹œì§€ìž…ë‹ˆë‹¤.
	//
	// ExecuteFuncëŠ” Taskê°€ ìˆ˜í–‰í•´ì•¼ í•  êµ¬ì²´ì ì¸ ìž‘ì—…(ìŠ¤í¬ëž˜í•‘, ë°ì´í„° ê°€ê³µ ë“±)ì„ ì •ì˜í•˜ë©°,
	// ì´ ì—ëŸ¬ëŠ” Task ìƒì„± ì‹œì ì˜ ì˜ì¡´ì„± ì£¼ìž… ëˆ„ë½(ê°œë°œìž ì‹¤ìˆ˜)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
	errMsgExecuteFuncNotInitialized = "Execute()ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"

	// errMsgScraperNotInitialized ì›¹ ìŠ¤í¬ëž˜í•‘ ê¸°ëŠ¥ì´ í•„ìš”í•œ Task(RequireScraper=true)ìž„ì—ë„ ë¶ˆêµ¬í•˜ê³ 
	// Scraper ì˜ì¡´ì„±ì´ ì£¼ìž…ë˜ì§€ ì•Šì•˜ì„ ë•Œ ë°œìƒí•˜ëŠ” ê°œë°œìž ëŒ€ìƒ ì—ëŸ¬ ë©”ì‹œì§€ìž…ë‹ˆë‹¤.
	//
	// ì´ ì—ëŸ¬ëŠ” Task ìƒì„± ì‹œì ì˜ ì˜ì¡´ì„± ì£¼ìž… ëˆ„ë½(ê°œë°œìž ì‹¤ìˆ˜)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
	errMsgScraperNotInitialized = "Scraperê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"

	// errMsgStorageNotInitialized ìž‘ì—… ê²°ê³¼(Snapshot)ë¥¼ ì €ìž¥í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ í•„ìš”í•œ
	// Storage ì˜ì¡´ì„±ì´ ì£¼ìž…ë˜ì§€ ì•Šì•˜ì„ ë•Œ ë°œìƒí•˜ëŠ” ê°œë°œìž ëŒ€ìƒ ì—ëŸ¬ ë©”ì‹œì§€ìž…ë‹ˆë‹¤.
	//
	// Snapshotì„ í†µí•´ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” TaskëŠ” ë°˜ë“œì‹œ Storage êµ¬í˜„ì²´ê°€ í•„ìš”í•˜ë©°,
	// ì´ ì—ëŸ¬ëŠ” Task ìƒì„± ì‹œì ì˜ ì˜ì¡´ì„± ì£¼ìž… ëˆ„ë½(ê°œë°œìž ì‹¤ìˆ˜)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
	errMsgStorageNotInitialized = "Storageê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"

	// errMsgSnapshotCreationFailed ìž‘ì—… ê²°ê³¼ë¥¼ ë‹´ì„ Snapshot ê°ì²´ ìƒì„±(NewSnapshot)ì´
	// ì‹¤íŒ¨í–ˆì„ ë•Œ ë°œìƒí•˜ëŠ” ê°œë°œìž ëŒ€ìƒ ì—ëŸ¬ ë©”ì‹œì§€ìž…ë‹ˆë‹¤.
	//
	// NewSnapshot íŒ©í† ë¦¬ í•¨ìˆ˜ê°€ nilì„ ë°˜í™˜í•˜ëŠ” ê²½ìš°ì— ì‚¬ìš©ë˜ë©°, ì´ëŠ” íŒ©í† ë¦¬ í•¨ìˆ˜ì˜ êµ¬í˜„ ì˜¤ë¥˜(ë²„ê·¸)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
	errMsgSnapshotCreationFailed = "ìž‘ì—… ê²°ê³¼ ê°ì²´(Snapshot) ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ (nil ë°˜í™˜)"
)

// Base ê°œë³„ Taskì˜ ì‹¤í–‰ ë‹¨ìœ„ì´ìž ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” í•µì‹¬ êµ¬ì¡°ì²´ìž…ë‹ˆë‹¤.
//
// ì´ êµ¬ì¡°ì²´ëŠ” Taskì˜ ì •ì˜(ë¬´ì—‡ì„, ì–´ë–»ê²Œ)ì™€ ì‹¤í–‰ ìƒíƒœ(ì–¸ì œ, ì–¼ë§ˆë‚˜)ë¥¼ ëª¨ë‘ ìº¡ìŠí™”í•˜ë©°,
// Service ë ˆì´ì–´ì— ì˜í•´ ìƒì„±ë˜ê³  ìƒëª…ì£¼ê¸°ê°€ ê´€ë¦¬ë©ë‹ˆë‹¤.
type Base struct {
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì‹ë³„ìž
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// id Taskì˜ ê³ ìœ  ì‹ë³„ìžìž…ë‹ˆë‹¤.
	id contract.TaskID

	// commandID Task ë‚´ì—ì„œ ì‹¤í–‰í•  Commandì˜ ê³ ìœ  ì‹ë³„ìžìž…ë‹ˆë‹¤.
	commandID contract.TaskCommandID

	// instanceID ì‹¤í–‰ëœ Task ì¸ìŠ¤í„´ìŠ¤ì˜ ê³ ìœ  ì‹ë³„ìžìž…ë‹ˆë‹¤.
	instanceID contract.TaskInstanceID

	// notifierID ìž‘ì—… ì™„ë£Œ ì‹œ ì•Œë¦¼ì„ ì „ì†¡í•  ëŒ€ìƒ ì±„ë„ì˜ ê³ ìœ  ì‹ë³„ìžìž…ë‹ˆë‹¤.
	notifierID contract.NotifierID

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì‹¤í–‰ ì œì–´
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// canceled ìž‘ì—… ì·¨ì†Œ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í”Œëž˜ê·¸ìž…ë‹ˆë‹¤.
	// atomic.Boolì„ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ ê³ ë£¨í‹´ì—ì„œ ì•ˆì „í•˜ê²Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.
	canceled atomic.Bool

	// ctxCancel Run() ì‹¤í–‰ ì¤‘ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì·¨ì†Œí•˜ê¸° ìœ„í•œ í•¨ìˆ˜ìž…ë‹ˆë‹¤.
	// Run() ì‹œìž‘ ì‹œ ì„¤ì •ë˜ê³  ì¢…ë£Œ ì‹œ nilë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
	ctxCancel context.CancelFunc

	// ctxCancelMu ctxCancel í•„ë“œì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì„ ë³´í˜¸í•˜ëŠ” ë®¤í…ìŠ¤ìž…ë‹ˆë‹¤.
	ctxCancelMu sync.Mutex

	// requireScraper ì´ Taskê°€ ì›¹ ìŠ¤í¬ëž˜í•‘ì„ í•„ìš”ë¡œ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
	// trueì¸ ê²½ìš° scraper í•„ë“œê°€ ë°˜ë“œì‹œ ì´ˆê¸°í™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
	requireScraper bool

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì‹¤í–‰ ë©”íƒ€ë°ì´í„°
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// runBy Taskì˜ ì‹¤í–‰ ì£¼ì²´ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
	// (ì˜ˆ: RunByUser - ì‚¬ìš©ìž ìˆ˜ë™ ì‹¤í–‰, RunByScheduler - ìŠ¤ì¼€ì¤„ëŸ¬ ìžë™ ì‹¤í–‰)
	runBy contract.TaskRunBy

	// startedAt Task ì‹¤í–‰ ì‹œìž‘ ì‹œê°ìž…ë‹ˆë‹¤.
	// startedAtMuì— ì˜í•´ ë³´í˜¸ë˜ë©°, Elapsed() ë©”ì„œë“œì—ì„œ ê²½ê³¼ ì‹œê°„ ê³„ì‚°ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
	startedAt time.Time

	// startedAtMu startedAt í•„ë“œì— ëŒ€í•œ ë™ì‹œ ì ‘ê·¼ì„ ë³´í˜¸í•˜ëŠ” ì½ê¸°/ì“°ê¸° ë®¤í…ìŠ¤ìž…ë‹ˆë‹¤.
	startedAtMu sync.RWMutex

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë° ì˜ì¡´ì„±
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// execute ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(ìŠ¤í¬ëž˜í•‘, ê°€ê²© ë¹„êµ ë“±)ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ìž…ë‹ˆë‹¤.
	// SetExecute() ë©”ì„œë“œë¥¼ í†µí•´ ê°œë³„ Task êµ¬í˜„ì²´ì—ì„œ ì£¼ìž…ë©ë‹ˆë‹¤.
	execute ExecuteFunc

	// scraper ì›¹ ìš”ì²­(HTTP) ë° HTML/JSON íŒŒì‹±ì„ ìˆ˜í–‰í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ìž…ë‹ˆë‹¤.
	// requireScraperê°€ trueì¸ ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
	scraper scraper.Scraper

	// storage ìž‘ì—… ê²°ê³¼ ë°ì´í„°(Snapshot)ë¥¼ ì˜êµ¬ ì €ìž¥í•˜ê³  ë¶ˆëŸ¬ì˜¤ëŠ” ì¸í„°íŽ˜ì´ìŠ¤ìž…ë‹ˆë‹¤.
	// ì´ì „ ì‹¤í–‰ ê²°ê³¼ ì¡°íšŒ(Load)ì™€ ìƒˆë¡œìš´ ê²°ê³¼ ì €ìž¥(Save)ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
	storage contract.TaskResultStore

	// newSnapshot ìž‘ì—… ê²°ê³¼ ë°ì´í„°ì˜ ë¹ˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” íŒ©í† ë¦¬ í•¨ìˆ˜ìž…ë‹ˆë‹¤.
	// Storage.Load() í˜¸ì¶œ ì‹œ ë°ì´í„°ë¥¼ ë‹´ì„ êµ¬ì¡°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
	newSnapshot NewSnapshotFunc

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ìœ í‹¸ë¦¬í‹°
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// logger ê³ ì • í•„ë“œ(task_id, command_id ë“±)ê°€ ë°”ì¸ë”©ëœ ë¡œê±° ì¸ìŠ¤í„´ìŠ¤ìž…ë‹ˆë‹¤.
	// ìƒì„± ì‹œì ì— ì´ˆê¸°í™”í•˜ì—¬ ë¡œê¹… ì‹œ ë§¤ë²ˆ í•„ë“œë¥¼ ë³µì‚¬í•˜ëŠ” ì˜¤ë²„í—¤ë“œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
	logger *applog.Entry
}

// ì»´íŒŒì¼ íƒ€ìž„ì— ì¸í„°íŽ˜ì´ìŠ¤ êµ¬í˜„ ì—¬ë¶€ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.
var _ Task = (*Base)(nil)

// baseParams Base êµ¬ì¡°ì²´ ì´ˆê¸°í™”ì— í•„ìš”í•œ ë§¤ê°œë³€ìˆ˜ë“¤ì„ ê·¸ë£¹í™”í•œ êµ¬ì¡°ì²´ìž…ë‹ˆë‹¤.
//
// ì„¤ê³„ ëª©ì :
//   - Base êµ¬ì¡°ì²´ ì´ˆê¸°í™”ì— í•„ìš”í•œ ë§¤ê°œë³€ìˆ˜ë“¤ì„ í•˜ë‚˜ì˜ êµ¬ì¡°ì²´ë¡œ ë¬¶ì–´ í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ ê°„ê²°í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.
//   - í–¥í›„ Base êµ¬ì¡°ì²´ í•„ë“œ ì¶”ê°€ ì‹œ ê¸°ì¡´ í˜¸ì¶œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” í™•ìž¥ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.
//   - í•„ë“œëª…ì„ í†µí•´ ê° ë§¤ê°œë³€ìˆ˜ì˜ ì˜ë¯¸ë¥¼ ëª…í™•ížˆ ì „ë‹¬í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ìž…ë‹ˆë‹¤.
type baseParams struct {
	ID         contract.TaskID
	CommandID  contract.TaskCommandID
	InstanceID contract.TaskInstanceID
	NotifierID contract.NotifierID

	RequireScraper bool

	RunBy contract.TaskRunBy

	Scraper     scraper.Scraper
	Storage     contract.TaskResultStore
	NewSnapshot NewSnapshotFunc
}

// newBase baseParamsë¥¼ ë°›ì•„ Base ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë‚´ë¶€ íŒ©í† ë¦¬ í•¨ìˆ˜ìž…ë‹ˆë‹¤.
//
// ì´ í•¨ìˆ˜ëŠ” íŒ¨í‚¤ì§€ ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©ë˜ë©°, ì™¸ë¶€ì—ì„œëŠ” NewBase() í•¨ìˆ˜ë¥¼ í†µí•´ ê°„ì ‘ì ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
// Base êµ¬ì¡°ì²´ì˜ ëª¨ë“  í•„ë“œë¥¼ ì´ˆê¸°í™”í•˜ë©°, íŠ¹ížˆ loggerëŠ” ìƒì„± ì‹œì ì— ê³ ì • í•„ë“œë¥¼ ë°”ì¸ë”©í•˜ì—¬
// ì´í›„ ë¡œê¹… ì‹œ ë§¤ë²ˆ í•„ë“œë¥¼ ë³µì‚¬í•˜ëŠ” ì˜¤ë²„í—¤ë“œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
//
// ë§¤ê°œë³€ìˆ˜:
//   - p: Base ì´ˆê¸°í™”ì— í•„ìš”í•œ ëª¨ë“  ë§¤ê°œë³€ìˆ˜ë¥¼ ë‹´ì€ êµ¬ì¡°ì²´
//
// ë°˜í™˜ê°’: ì™„ì „ížˆ ì´ˆê¸°í™”ëœ Base ì¸ìŠ¤í„´ìŠ¤ í¬ì¸í„°
func newBase(p baseParams) *Base {
	return &Base{
		id:         p.ID,
		commandID:  p.CommandID,
		instanceID: p.InstanceID,
		notifierID: p.NotifierID,

		requireScraper: p.RequireScraper,

		runBy: p.RunBy,

		scraper:     p.Scraper,
		storage:     p.Storage,
		newSnapshot: p.NewSnapshot,

		logger: applog.WithFields(applog.Fields{
			"task_id":         p.ID,
			"command_id":      p.CommandID,
			"instance_id":     p.InstanceID,
			"notifier_id":     p.NotifierID,
			"require_scraper": p.RequireScraper,
			"run_by":          p.RunBy,
		}),
	}
}

// NewBase NewTaskParamsë¥¼ ê¸°ë°˜ìœ¼ë¡œ Base ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ê³µê°œ íŒ©í† ë¦¬ í•¨ìˆ˜ìž…ë‹ˆë‹¤.
//
// ì´ í•¨ìˆ˜ëŠ” ê°œë³„ Task êµ¬í˜„ì²´(kurly, naver, lotto ë“±)ì˜ NewTask ë©”ì„œë“œì—ì„œ í˜¸ì¶œë˜ë©°,
// ë°˜ë³µì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” Base ì´ˆê¸°í™” ì½”ë“œë¥¼ ê°„ì†Œí™”í•˜ì—¬ ì½”ë“œ ì¤‘ë³µì„ ë°©ì§€í•©ë‹ˆë‹¤.
// NewTaskParamsë¥¼ ë‚´ë¶€ baseParamsë¡œ ë³€í™˜í•˜ê³ , í•„ìš” ì‹œ Scraperë¥¼ ì´ˆê¸°í™”í•œ í›„
// newBase() ë‚´ë¶€ íŒ©í† ë¦¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì™„ì „ížˆ ì´ˆê¸°í™”ëœ Base ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
//
// ë§¤ê°œë³€ìˆ˜:
//   - p: Task ìƒì„±ì— í•„ìš”í•œ ëª¨ë“  ë§¤ê°œë³€ìˆ˜ë¥¼ ë‹´ì€ êµ¬ì¡°ì²´
//   - requireScraper: ì›¹ ìŠ¤í¬ëž˜í•‘ ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€
//     (trueë¡œ ì„¤ì • ì‹œ p.Fetcherê°€ í•„ìˆ˜ì´ë©°, nilì¼ ê²½ìš° íŒ¨ë‹‰ ë°œìƒ)
//
// ë°˜í™˜ê°’: ì™„ì „ížˆ ì´ˆê¸°í™”ëœ Base ì¸ìŠ¤í„´ìŠ¤ í¬ì¸í„°
func NewBase(p NewTaskParams, requireScraper bool) *Base {
	if p.Request == nil {
		panic("NewBase: params.RequestëŠ” í•„ìˆ˜ìž…ë‹ˆë‹¤")
	}

	// ì›¹ ìŠ¤í¬ëž˜í•‘ì´ í•„ìš”í•œ Taskì¸ ê²½ìš°, Fetcher ì˜ì¡´ì„±ì„ ê²€ì¦í•˜ê³  Scraperë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
	var scr scraper.Scraper
	if requireScraper {
		if p.Fetcher == nil {
			panic(fmt.Sprintf("NewBase: ìŠ¤í¬ëž˜í•‘ ìž‘ì—…ì—ëŠ” Fetcher ì£¼ìž…ì´ í•„ìˆ˜ìž…ë‹ˆë‹¤ (TaskID=%s)", p.Request.TaskID))
		}

		scr = scraper.New(p.Fetcher)
	}

	return newBase(baseParams{
		ID:         p.Request.TaskID,
		CommandID:  p.Request.CommandID,
		InstanceID: p.InstanceID,
		NotifierID: p.Request.NotifierID,

		RequireScraper: requireScraper,

		RunBy: p.Request.RunBy,

		Scraper:     scr,
		Storage:     p.Storage,
		NewSnapshot: p.NewSnapshot,
	})
}

func (b *Base) ID() contract.TaskID {
	return b.id
}

func (b *Base) CommandID() contract.TaskCommandID {
	return b.commandID
}

func (b *Base) InstanceID() contract.TaskInstanceID {
	return b.instanceID
}

func (b *Base) NotifierID() contract.NotifierID {
	return b.notifierID
}

func (b *Base) Cancel() {
	b.canceled.Store(true)

	// í˜„ìž¬ ì‹¤í–‰ ì¤‘(Run ë©”ì„œë“œê°€ í˜¸ì¶œëœ ìƒíƒœ)ì´ë¼ë©´, í• ë‹¹ëœ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¦‰ì‹œ ì·¨ì†Œí•˜ì—¬
	// ì§„í–‰ ì¤‘ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(ë„¤íŠ¸ì›Œí¬ ìš”ì²­, ë°ì´í„° ì²˜ë¦¬ ë“±)ì´ ì¡°ì†ížˆ ì¤‘ë‹¨ë˜ë„ë¡ ìœ ë„í•©ë‹ˆë‹¤.
	b.ctxCancelMu.Lock()
	if b.ctxCancel != nil {
		b.ctxCancel()
	}
	b.ctxCancelMu.Unlock()
}

func (b *Base) IsCanceled() bool {
	return b.canceled.Load()
}

func (b *Base) RunBy() contract.TaskRunBy {
	return b.runBy
}

func (b *Base) Elapsed() time.Duration {
	b.startedAtMu.RLock()
	defer b.startedAtMu.RUnlock()

	// ìž‘ì—…ì´ ì‹¤í–‰ëœ ì ì´ ì—†ê±°ë‚˜ ì‹œìž‘ ì‹œê°ì´ ê¸°ë¡ë˜ì§€ ì•Šì€ ê²½ìš° 0ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
	if b.startedAt.IsZero() {
		return 0
	}

	// í˜„ìž¬ ì‹œê°ê³¼ ì‹œìž‘ ì‹œê°ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ê²½ê³¼ ì‹œê°„ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
	return time.Since(b.startedAt)
}

func (b *Base) SetExecute(execute ExecuteFunc) {
	b.execute = execute
}

func (b *Base) Scraper() scraper.Scraper {
	return b.scraper
}

// Run Taskì˜ ì „ì²´ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ë©”ì¸ ì§„ìž…ì ìž…ë‹ˆë‹¤.
//
// ì´ ë©”ì„œë“œëŠ” Task ì¸í„°íŽ˜ì´ìŠ¤ì˜ í•µì‹¬ ë©”ì„œë“œë¡œì„œ, Service ë ˆì´ì–´ì—ì„œ í˜¸ì¶œë˜ì–´
// Taskì˜ ìƒì„±ë¶€í„° ì¢…ë£Œê¹Œì§€ì˜ ì „ì²´ ìƒëª…ì£¼ê¸°ë¥¼ ì œì–´í•©ë‹ˆë‹¤.
//
// ë§¤ê°œë³€ìˆ˜:
//   - ctx: Task ì‹¤í–‰ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ì œì–´í•˜ëŠ” ì»¨í…ìŠ¤íŠ¸ (íƒ€ìž„ì•„ì›ƒ, ì·¨ì†Œ ì‹ í˜¸ ì „íŒŒ)
//   - notificationSender: ìž‘ì—… ê²°ê³¼ë¥¼ ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¬ê¸° ìœ„í•œ ì¸í„°íŽ˜ì´ìŠ¤ êµ¬í˜„ì²´ (í•„ìˆ˜)
func (b *Base) Run(ctx context.Context, notificationSender contract.NotificationSender) {
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì‚¬ì „ ê²€ì¦: í•„ìˆ˜ ì˜ì¡´ì„± í™•ì¸ ë° ì¡°ê¸° ì·¨ì†Œ ê°ì§€
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// notificationSenderëŠ” Task ìž‘ì—… ê²°ê³¼ë¥¼ ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¬ê¸° ìœ„í•œ í•„ìˆ˜ ì˜ì¡´ì„±ìž…ë‹ˆë‹¤.
	// nilì¸ ê²½ìš° ìž‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì¦‰ì‹œ ì¢…ë£Œí•©ë‹ˆë‹¤.
	if notificationSender == nil {
		b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì‹¤í–‰ ì¤‘ë‹¨: NotificationSender ì˜ì¡´ì„± ëˆ„ë½", nil, nil)
		return
	}

	// Run() í˜¸ì¶œ ì „ì— ì´ë¯¸ Cancel()ì´ í˜¸ì¶œëœ ê²½ìš°ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
	// ì´ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ê°€ Taskë¥¼ íì— ë„£ì—ˆì§€ë§Œ, ì‹¤í–‰ ì „ì— ì‚¬ìš©ìžê°€ ì·¨ì†Œí•œ ê²½ìš° ë“±ì— í•´ë‹¹í•©ë‹ˆë‹¤.
	// ì¡°ê¸° ì¢…ë£Œ(Early Exit)ë¥¼ í†µí•´ ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ì„ ë°©ì§€í•©ë‹ˆë‹¤.
	if b.IsCanceled() {
		b.Log(component, applog.InfoLevel, "ìž‘ì—… ì‹¤í–‰ ì¤‘ë‹¨: ì»¨í…ìŠ¤íŠ¸ ì·¨ì†Œ (ì‹œìž‘ ì „)", nil, nil)
		return
	}

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì»¨í…ìŠ¤íŠ¸ ì„¤ì •: ì·¨ì†Œ ê°€ëŠ¥í•œ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ë° ìƒëª…ì£¼ê¸° ê´€ë¦¬
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// ìƒìœ„ ì»¨í…ìŠ¤íŠ¸ë¥¼ ëž˜í•‘í•˜ì—¬ ì´ Task ì „ìš© ì·¨ì†Œ ê°€ëŠ¥í•œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
	// ì´ë¥¼ í†µí•´ Cancel() ë©”ì„œë“œ í˜¸ì¶œ ì‹œ ì§„í–‰ ì¤‘ì¸ ëª¨ë“  í•˜ìœ„ ìž‘ì—…(ë„¤íŠ¸ì›Œí¬ ìš”ì²­, DB ì¿¼ë¦¬ ë“±)ì—
	// ì¦‰ì‹œ ì·¨ì†Œ ì‹ í˜¸ë¥¼ ì „íŒŒí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
	ctx, cancel := context.WithCancel(ctx)
	defer cancel()

	// cancel í•¨ìˆ˜ë¥¼ Base êµ¬ì¡°ì²´ì— ì €ìž¥í•˜ì—¬ ì™¸ë¶€(Cancel ë©”ì„œë“œ)ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.
	b.ctxCancelMu.Lock()
	b.ctxCancel = cancel
	b.ctxCancelMu.Unlock()

	// Run() ì¢…ë£Œ ì‹œ cancel í•¨ìˆ˜ ì°¸ì¡°ë¥¼ ì •ë¦¬í•˜ì—¬ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
	// ì´í›„ Cancel() í˜¸ì¶œì€ ì´ë¯¸ ì¢…ë£Œëœ Taskì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
	defer func() {
		b.ctxCancelMu.Lock()
		defer b.ctxCancelMu.Unlock()

		b.ctxCancel = nil
	}()

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// íŒ¨ë‹‰ ë³µêµ¬: ì˜ˆìƒì¹˜ ëª»í•œ íŒ¨ë‹‰ ë°œìƒ ì‹œ ì‹œìŠ¤í…œ ì•ˆì •ì„± ìœ ì§€
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// Task ì‹¤í–‰ ì¤‘ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ëª¨ë“  íŒ¨ë‹‰ì„ ë³µêµ¬í•˜ì—¬ ì „ì²´ ì„œë¹„ìŠ¤ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡ ë³´í˜¸í•©ë‹ˆë‹¤.
	// íŒ¨ë‹‰ì´ ë°œìƒí•˜ë”ë¼ë„ ë‹¤ìŒ ë‘ ê°€ì§€ í•µì‹¬ ìž‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
	//   1. ìƒì„¸í•œ íŒ¨ë‹‰ ì •ë³´ë¥¼ ë¡œê·¸ì— ê¸°ë¡í•˜ì—¬ ë””ë²„ê¹… ê°€ëŠ¥í•˜ë„ë¡ í•¨
	//   2. ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ ì•Œë¦¼ì„ ì „ì†¡í•˜ì—¬ ìž‘ì—… ì‹¤íŒ¨ë¥¼ ì¸ì§€í•  ìˆ˜ ìžˆë„ë¡ í•¨
	defer func() {
		if r := recover(); r != nil {
			// 1ë‹¨ê³„: íŒ¨ë‹‰ ì •ë³´ë¥¼ ì¦‰ì‹œ ë¡œê·¸ì— ê¸°ë¡í•©ë‹ˆë‹¤.
			// ë¡œê¹…ì€ ê°€ìž¥ ì•ˆì „í•œ ìž‘ì—…ì´ë¯€ë¡œ ìµœìš°ì„ ìœ¼ë¡œ ìˆ˜í–‰í•˜ì—¬ íŒ¨ë‹‰ ì›ì¸ì„ ë³´ì¡´í•©ë‹ˆë‹¤.
			b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì‹¤í–‰ ì¤‘ë‹¨: ëŸ°íƒ€ìž„ íŒ¨ë‹‰ ë°œìƒ", newErrRuntimePanic(r, b.id, b.commandID), applog.Fields{
				"panic": r,
			})

			// 2ë‹¨ê³„: ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.
			// ì•Œë¦¼ ì „ì†¡ ìžì²´ê°€ íŒ¨ë‹‰ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ, ë³„ë„ì˜ ìµëª… í•¨ìˆ˜ë¡œ ê²©ë¦¬í•˜ê³ 
			// ë‚´ë¶€ì— ë˜ ë‹¤ë¥¸ recoverë¥¼ ì„¤ì¹˜í•˜ì—¬ 2ì°¨ íŒ¨ë‹‰ì„ ë°©ì§€í•©ë‹ˆë‹¤.
			func() {
				defer func() {
					if r2 := recover(); r2 != nil {
						// 2ì°¨ íŒ¨ë‹‰ì´ ë°œìƒí•œ ê²½ìš°, ë¡œê·¸ë§Œ ê¸°ë¡í•˜ê³  ë” ì´ìƒ ì•Œë¦¼ì„ ì‹œë„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
						// ì´ëŠ” ë¬´í•œ ìž¬ê·€ë¥¼ ë°©ì§€í•˜ê³  ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ í•©ë‹ˆë‹¤.
						b.Log(component, applog.ErrorLevel, "ì•Œë¦¼ ì²˜ë¦¬ ì¤‘ë‹¨: íŒ¨ë‹‰ ë³µêµ¬ ì¤‘ 2ì°¨ íŒ¨ë‹‰ ë°œìƒ", nil, applog.Fields{
							"secondary_panic": r2,
						})
					}
				}()

				if notificationSender != nil && b != nil {
					// ì‚¬ìš©ìžì—ê²Œ ì „ë‹¬í•  íŒ¨ë‹‰ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
					message := b.formatTaskErrorMessage(fmt.Sprintf("ì‹œìŠ¤í…œ ë‚´ë¶€ ì˜¤ë¥˜(Panic)ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.\n\n[ì˜¤ë¥˜ ìƒì„¸ ë‚´ìš©]\n%v", r))

					_ = notificationSender.Notify(context.WithoutCancel(ctx), b.newNotification(message, true))
				}
			}()
		}
	}()

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì‹¤í–‰ ì‹œìž‘ ì‹œê° ê¸°ë¡
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// Task ì‹¤í–‰ ì‹œìž‘ ì‹œê°ì„ ê¸°ë¡í•˜ì—¬ Elapsed() ë©”ì„œë“œì—ì„œ ê²½ê³¼ ì‹œê°„ì„ ê³„ì‚°í•  ìˆ˜ ìžˆë„ë¡ í•©ë‹ˆë‹¤.
	b.startedAtMu.Lock()
	b.startedAt = time.Now()
	b.startedAtMu.Unlock()

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 1ë‹¨ê³„: ì‹¤í–‰ ì¤€ë¹„ - ì˜ì¡´ì„± ê²€ì¦ ë° ì´ì „ ìž‘ì—… ê²°ê³¼ ë¡œë”©
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// prepareExecution()ì€ ë‹¤ìŒ ìž‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
	//   - execute, scraper, storage ë“± í•„ìˆ˜ ì˜ì¡´ì„±ì´ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ ê²€ì¦
	//   - Storageì—ì„œ ì´ì „ ìž‘ì—… ê²°ê³¼(Snapshot)ë¥¼ ë¡œë”©í•˜ì—¬ ë¹„êµ ê¸°ë°˜ ìž‘ì—… ì§€ì›
	// ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë©°, ì´ ê²½ìš° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•˜ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤.
	previousSnapshot, err := b.prepareExecution(ctx, notificationSender)
	if err != nil {
		return
	}

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì·¨ì†Œ í™•ì¸ #2: ì¤€ë¹„ ìž‘ì—… ì™„ë£Œ í›„, ì‹¤í–‰ ì§ì „
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// prepareExecution() ì¤‘ì— ì·¨ì†Œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ ê²½ìš°ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
	// Storage Load ë“±ì˜ ì¤€ë¹„ ìž‘ì—…ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ, ë¬´ê±°ìš´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(execute)ì„
	// ì‹¤í–‰í•˜ê¸° ì „ì— ì·¨ì†Œ ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ë¶ˆí•„ìš”í•œ CPU/ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ì„ ë°©ì§€í•©ë‹ˆë‹¤.
	if b.IsCanceled() {
		b.Log(component, applog.InfoLevel, "ìž‘ì—… ì‹¤í–‰ ì¤‘ë‹¨: ì»¨í…ìŠ¤íŠ¸ ì·¨ì†Œ (ì¤€ë¹„ ì™„ë£Œ í›„)", nil, nil)
		return
	}

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 2ë‹¨ê³„: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// execute í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤ì œ ìž‘ì—…(ì›¹ ìŠ¤í¬ëž˜í•‘, ë°ì´í„° ê°€ê³µ, ë¹„êµ ë“±)ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
	//
	// ë°˜í™˜ê°’:
	//   - message: ì‚¬ìš©ìžì—ê²Œ ì „ì†¡í•  ì•Œë¦¼ ë©”ì‹œì§€ (ì„±ê³µ ì‹œ)
	//   - newSnapshot: ì €ìž¥í•  ìƒˆë¡œìš´ ìž‘ì—… ê²°ê³¼ ë°ì´í„° (nilì´ë©´ ì €ìž¥ ìƒëžµ)
	//   - err: ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ì—ëŸ¬ (nilì´ë©´ ì„±ê³µ)
	message, newSnapshot, err := b.execute(ctx, previousSnapshot, notificationSender.SupportsHTML(b.notifierID))

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ì·¨ì†Œ í™•ì¸ #3: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰ ì™„ë£Œ í›„, ê²°ê³¼ ì²˜ë¦¬ ì§ì „
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// execute ì‹¤í–‰ ì¤‘ì— ì·¨ì†Œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ ê²½ìš°ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
	// ì´ë¯¸ ìž‘ì—…ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ, Snapshot ì €ìž¥ì´ë‚˜ ì•Œë¦¼ ì „ì†¡ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  ì¢…ë£Œí•˜ì—¬
	// ì·¨ì†Œëœ ìž‘ì—…ì˜ ê²°ê³¼ê°€ ì‚¬ìš©ìžì—ê²Œ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
	if b.IsCanceled() {
		b.Log(component, applog.InfoLevel, "ê²°ê³¼ ì²˜ë¦¬ ì¤‘ë‹¨: ì»¨í…ìŠ¤íŠ¸ ì·¨ì†Œ (ì‹¤í–‰ ì™„ë£Œ í›„)", nil, nil)
		return
	}

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 3ë‹¨ê³„: ê²°ê³¼ ì²˜ë¦¬ - Snapshot ì €ìž¥ ë° ì‚¬ìš©ìž ì•Œë¦¼ ì „ì†¡
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// finalizeExecution()ëŠ” executeì˜ ë°˜í™˜ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒ ìž‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
	//   - ì—ëŸ¬ ë°œìƒ ì‹œ: ì—ëŸ¬ ë¡œê¹… ë° ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ ì•Œë¦¼ ì „ì†¡
	//   - ì„±ê³µ ì‹œ: Snapshot ì €ìž¥ â†’ ì‚¬ìš©ìžì—ê²Œ ì„±ê³µ ì•Œë¦¼ ì „ì†¡
	b.finalizeExecution(ctx, notificationSender, message, newSnapshot, err)
}

// prepareExecution Task ì‹¤í–‰ ì „ í•„ìˆ˜ ì¡°ê±´ì„ ê²€ì¦í•˜ê³  ì´ì „ ìž‘ì—… ê²°ê³¼ Snapshotì„ ì¤€ë¹„í•˜ëŠ” ì‚¬ì „ ê²€ì¦ ë‹¨ê³„ìž…ë‹ˆë‹¤.
//
// ì´ ë©”ì„œë“œëŠ” Run() ë©”ì„œë“œì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(execute)ì„ ì‹¤í–‰í•˜ê¸° ì „ì— í˜¸ì¶œë˜ë©°,
// ë‹¤ìŒ ë‘ ê°€ì§€ í•µì‹¬ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
//
//  1. í•„ìˆ˜ ì˜ì¡´ì„± ê²€ì¦
//     - execute í•¨ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
//     - ì›¹ ìŠ¤í¬ëž˜í•‘ì´ í•„ìš”í•œ Taskì¸ ê²½ìš° Scraper ì¸ìŠ¤í„´ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
//
//  2. ì´ì „ ìž‘ì—… ê²°ê³¼(Snapshot) ë¡œë”©
//     - Snapshot ìƒì„± íŒ©í† ë¦¬ í•¨ìˆ˜(newSnapshot)ê°€ ë“±ë¡ëœ ê²½ìš°, Storageì—ì„œ ì´ì „ ìž‘ì—… ê²°ê³¼ë¥¼ ë¡œë“œ
//
// ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ê³  ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¼ì„ ì „ì†¡í•œ í›„ ì¦‰ì‹œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ì—¬
// ë¶ˆì™„ì „í•œ ìƒíƒœì—ì„œì˜ ì‹¤í–‰ì„ ë°©ì§€í•©ë‹ˆë‹¤.
//
// ë§¤ê°œë³€ìˆ˜:
//   - ctx: ìž‘ì—… ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ (ì·¨ì†Œ ì‹ í˜¸ ì „íŒŒ ìš©ë„)
//   - notificationSender: ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì•Œë¦¼ ì „ì†¡ì„ ë‹´ë‹¹í•˜ëŠ” ì¸í„°íŽ˜ì´ìŠ¤ êµ¬í˜„ì²´
//
// ë°˜í™˜ê°’:
//   - any: ì´ì „ ìž‘ì—… ê²°ê³¼ Snapshot (ìµœì´ˆ ì‹¤í–‰ì´ê±°ë‚˜ newSnapshotì´ nilì¸ ê²½ìš° nil)
//   - error: ê²€ì¦ ì‹¤íŒ¨ ë˜ëŠ” Snapshot ë¡œë”© ì‹¤íŒ¨ ì‹œ ì—ëŸ¬
func (b *Base) prepareExecution(ctx context.Context, notificationSender contract.NotificationSender) (any, error) {
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 1ë‹¨ê³„: í•„ìˆ˜ ì˜ì¡´ì„± ê²€ì¦
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	// ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰ í•¨ìˆ˜(execute)ê°€ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
	// executeëŠ” ê°œë³„ Task êµ¬í˜„ì²´ì—ì„œ SetExecute()ë¥¼ í†µí•´ ì£¼ìž…ë˜ì–´ì•¼ í•˜ë©°, ì´ í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ TaskëŠ” ì‹¤ì§ˆì ì¸ ìž‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
	if b.execute == nil {
		message := b.formatTaskErrorMessage(errMsgExecuteFuncNotInitialized)

		b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì¤€ë¹„ ì‹¤íŒ¨: ExecuteFunc ì˜ì¡´ì„± ëˆ„ë½", nil, applog.Fields{
			"notification_message": message,
		})

		b.sendErrorNotification(ctx, notificationSender, message)

		return nil, newErrExecuteFuncNotInitialized(b.id, b.commandID)
	}

	// ì›¹ ìŠ¤í¬ëž˜í•‘ì´ í•„ìš”í•œ Taskì¸ ê²½ìš°, Scraperê°€ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
	if b.requireScraper && b.scraper == nil {
		message := b.formatTaskErrorMessage(errMsgScraperNotInitialized)

		b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì¤€ë¹„ ì‹¤íŒ¨: Scraper ì˜ì¡´ì„± ëˆ„ë½", nil, applog.Fields{
			"notification_message": message,
		})

		b.sendErrorNotification(ctx, notificationSender, message)

		return nil, newErrScraperNotInitialized(b.id, b.commandID)
	}

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 2ë‹¨ê³„: ì´ì „ ìž‘ì—… ê²°ê³¼(Snapshot) ë¡œë”©
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

	var snapshot any

	// Snapshot ìƒì„± íŒ©í† ë¦¬ í•¨ìˆ˜(newSnapshot)ê°€ ë“±ë¡ëœ ê²½ìš°, ì´ì „ ìž‘ì—… ê²°ê³¼ë¥¼ ë¡œë”©í•©ë‹ˆë‹¤.
	if b.newSnapshot != nil {
		// ë¹„ì–´ìžˆëŠ” Snapshot ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
		snapshot = b.newSnapshot()

		// Snapshot ìƒì„± ì‹¤íŒ¨ëŠ” íŒ©í† ë¦¬ í•¨ìˆ˜ì˜ êµ¬í˜„ ì˜¤ë¥˜ë¥¼ ì˜ë¯¸í•˜ë¯€ë¡œ ì¦‰ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬í•©ë‹ˆë‹¤.
		if snapshot == nil {
			message := b.formatTaskErrorMessage(errMsgSnapshotCreationFailed)

			b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì¤€ë¹„ ì‹¤íŒ¨: Snapshot ìƒì„± ì‹¤íŒ¨", nil, applog.Fields{
				"notification_message": message,
			})

			b.sendErrorNotification(ctx, notificationSender, message)

			return nil, newErrSnapshotCreationFailed(b.id, b.commandID)
		}

		// Snapshot ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìœ¼ë¯€ë¡œ, ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê¸° ìœ„í•œ Storageê°€ ë°˜ë“œì‹œ ì´ˆê¸°í™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
		if b.storage == nil {
			message := b.formatTaskErrorMessage(errMsgStorageNotInitialized)

			b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì¤€ë¹„ ì‹¤íŒ¨: Storage ì˜ì¡´ì„± ëˆ„ë½", nil, applog.Fields{
				"notification_message": message,
			})

			b.sendErrorNotification(ctx, notificationSender, message)

			return nil, newErrStorageNotInitialized(b.id, b.commandID)
		}

		// Storageì—ì„œ ì´ì „ ìž‘ì—… ê²°ê³¼ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
		if err := b.storage.Load(b.ID(), b.CommandID(), snapshot); err != nil {
			// ìµœì´ˆ ì‹¤í–‰ ì‹œì—ëŠ” ì´ì „ ìž‘ì—… ê²°ê³¼ê°€ ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ErrTaskResultNotFound ì—ëŸ¬ëŠ” ì •ìƒì ì¸ ìƒí™©ìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
			// ë”°ë¼ì„œ ì—ëŸ¬ë¡œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ë¡œê·¸ë§Œ ë‚¨ê¸´ í›„ ìž‘ì—…ì„ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.
			if errors.Is(err, contract.ErrTaskResultNotFound) {
				b.Log(component, applog.InfoLevel, "ìŠ¤ëƒ…ìƒ· ë¡œë”© ìƒëžµ: ì €ìž¥ëœ ë°ì´í„° ì—†ìŒ (ìµœì´ˆ ì‹¤í–‰)", nil, nil)
			} else {
				// ê·¸ ì™¸ì˜ ì—ëŸ¬(íŒŒì¼ ì‹œìŠ¤í…œ ì˜¤ë¥˜, ì—­ì§ë ¬í™” ì‹¤íŒ¨ ë“±)ëŠ” ì‹¤ì œ ë¬¸ì œì´ë¯€ë¡œ ì—ëŸ¬ ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ê³ 
				// ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ ì•Œë¦¼ì„ ì „ì†¡í•œ í›„ ì‹¤í–‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
				message := fmt.Sprintf(notifySnapshotLoadFailedFormat, err)

				b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì¤€ë¹„ ì‹¤íŒ¨: ì´ì „ ìŠ¤ëƒ…ìƒ· ë¡œë”© ì—ëŸ¬", err, applog.Fields{
					"notification_message": message,
				})

				// ì‚¬ìš©ìžê°€ ëª…ì‹œì ìœ¼ë¡œ ìž‘ì—…ì„ ì·¨ì†Œí•œ ê²½ìš°ì—ëŠ”, ë¶ˆí•„ìš”í•œ ì•Œë¦¼ ì†ŒìŒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì—ëŸ¬ ì•Œë¦¼ ì „ì†¡ì„ ìƒëžµí•©ë‹ˆë‹¤.
				if !errors.Is(err, context.Canceled) {
					b.sendErrorNotification(ctx, notificationSender, message)
				}

				return nil, newErrSnapshotLoadingFailed(err, b.id, b.commandID)
			}
		}
	}

	return snapshot, nil
}

// finalizeExecution ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(execute) ì‹¤í–‰ í›„ ë°˜í™˜ëœ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ê³  ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.
//
// ì´ ë©”ì„œë“œëŠ” Task ì‹¤í–‰ì˜ ë§ˆì§€ë§‰ ë‹¨ê³„ë¡œì„œ, execute í•¨ìˆ˜ê°€ ë°˜í™˜í•œ ê²°ê³¼(ì„±ê³µ/ì‹¤íŒ¨)ì— ë”°ë¼
// ë‹¤ìŒ ì„¸ ê°€ì§€ í•µì‹¬ ìž‘ì—…ì„ ìˆœì°¨ì ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤:
//
//  1. ì—ëŸ¬ ì²˜ë¦¬: execute ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ì—ëŸ¬ë¥¼ ë¡œê¹…í•˜ê³  ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ ì•Œë¦¼ ì „ì†¡
//  2. ìƒíƒœ ì €ìž¥: ìƒˆë¡œìš´ ìž‘ì—… ê²°ê³¼(Snapshot)ë¥¼ Storageì— ì˜êµ¬ ì €ìž¥
//  3. ì„±ê³µ ì•Œë¦¼: ëª¨ë“  ê³¼ì •ì´ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©ìžì—ê²Œ ì„±ê³µ ë©”ì‹œì§€ ì „ì†¡
//
// ë§¤ê°œë³€ìˆ˜:
//   - ctx: ì•Œë¦¼ ì „ì†¡ ë° ì €ìž¥ ìž‘ì—…ì˜ ì»¨í…ìŠ¤íŠ¸ (ì·¨ì†Œ ì‹ í˜¸ ì „íŒŒ ìš©ë„)
//   - notificationSender: ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¼ ì „ì†¡ì„ ë‹´ë‹¹í•˜ëŠ” ì¸í„°íŽ˜ì´ìŠ¤ êµ¬í˜„ì²´
//   - message: executeê°€ ìƒì„±í•œ ì‚¬ìš©ìž ëŒ€ìƒ ì•Œë¦¼ ë©”ì‹œì§€ (ì„±ê³µ ì‹œ ì „ì†¡ë  ë‚´ìš©)
//   - newSnapshot: executeê°€ ìƒì„±í•œ ìƒˆë¡œìš´ ìž‘ì—… ê²°ê³¼ ë°ì´í„° (nilì´ë©´ ì €ìž¥ ìƒëžµ)
//   - err: execute ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ì—ëŸ¬ (nilì´ë©´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼)
func (b *Base) finalizeExecution(ctx context.Context, notificationSender contract.NotificationSender, message string, newSnapshot any, err error) {
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 1ë‹¨ê³„: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(execute) ì‹¤í–‰ ì—ëŸ¬ ì²˜ë¦¬
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// execute í•¨ìˆ˜ê°€ ì—ëŸ¬ë¥¼ ë°˜í™˜í•œ ê²½ìš°, ìž‘ì—… ì‹¤í–‰ì´ ì‹¤íŒ¨í–ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
	// ì´ ê²½ìš° Snapshot ì €ìž¥ì´ë‚˜ ì„±ê³µ ì•Œë¦¼ì„ ì‹œë„í•˜ì§€ ì•Šê³  ì¦‰ì‹œ ì—ëŸ¬ ì²˜ë¦¬ í›„ ì¢…ë£Œí•©ë‹ˆë‹¤.
	if err != nil {
		// ì‚¬ìš©ìžì—ê²Œ ì „ì†¡í•  ì—ëŸ¬ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
		notifyMsg := b.formatTaskErrorMessage(err)

		// executeê°€ ì—ëŸ¬ì™€ í•¨ê»˜ ë¶€ê°€ ì •ë³´(message)ë¥¼ ë°˜í™˜í•œ ê²½ìš°, ì´ë¥¼ ì—ëŸ¬ ì•Œë¦¼ ë©”ì‹œì§€ì— ì¶”ê°€í•˜ì—¬ ì‚¬ìš©ìžì—ê²Œ ë” ë§Žì€ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
		if len(message) > 0 {
			notifyMsg = fmt.Sprintf("%s\n\n%s", notifyMsg, message)
		}

		b.Log(component, applog.ErrorLevel, "ìž‘ì—… ì‹¤í–‰ ì‹¤íŒ¨: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(execute) ì—ëŸ¬", err, applog.Fields{
			"notification_message": notifyMsg,
		})

		// ì‚¬ìš©ìžê°€ ëª…ì‹œì ìœ¼ë¡œ ìž‘ì—…ì„ ì·¨ì†Œí•œ ê²½ìš°ì—ëŠ”, ë¶ˆí•„ìš”í•œ ì•Œë¦¼ ì†ŒìŒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì—ëŸ¬ ì•Œë¦¼ ì „ì†¡ì„ ìƒëžµí•©ë‹ˆë‹¤.
		if !errors.Is(err, context.Canceled) {
			b.sendErrorNotification(ctx, notificationSender, notifyMsg)
		}

		return
	}

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 2ë‹¨ê³„: ìž‘ì—… ê²°ê³¼(Snapshot) ì €ìž¥
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// executeê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆê³  ìƒˆë¡œìš´ Snapshotì„ ë°˜í™˜í•œ ê²½ìš°,
	// ì´ë¥¼ Storageì— ì €ìž¥í•˜ì—¬ ë‹¤ìŒ ì‹¤í–‰ ì‹œ ì°¸ì¡°í•  ìˆ˜ ìžˆë„ë¡ ì˜ì†í™”í•©ë‹ˆë‹¤.
	if newSnapshot != nil {
		if b.storage != nil {
			if saveErr := b.storage.Save(b.ID(), b.CommandID(), newSnapshot); saveErr != nil {
				// ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(execute)ì€ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ, Snapshot ì €ìž¥ ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ì¤‘ìš” ì •ë³´(message)ëŠ”
				// ì‚¬ìš©ìžì—ê²Œ ë°˜ë“œì‹œ ì „ë‹¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì €ìž¥ ì‹¤íŒ¨ë¡œ ì¸í•´ ì‚¬ìš©ìžê°€ ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê²°ê³¼ë¥¼
				// ë†“ì¹˜ëŠ” ì¼ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì—ëŸ¬ ì•Œë¦¼ì— ì‹¤í–‰ ê²°ê³¼ë¥¼ í¬í•¨í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
				notifyMsg := fmt.Sprintf(notifySnapshotSaveFailedFormat, saveErr)
				if len(message) > 0 {
					notifyMsg = fmt.Sprintf("%s\n\n[ìž‘ì—… ì‹¤í–‰ ê²°ê³¼ ìƒì„¸]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n%s", notifyMsg, message)
				}

				b.Log(component, applog.ErrorLevel, "ìŠ¤ëƒ…ìƒ· ì €ìž¥ ì‹¤íŒ¨: Storage ì €ìž¥ ì—ëŸ¬", saveErr, applog.Fields{
					"notification_message": notifyMsg,
				})

				b.sendErrorNotification(ctx, notificationSender, notifyMsg)

				return
			}
		} else {
			// Taskê°€ ìž‘ì—… ê²°ê³¼(Snapshot)ë¥¼ ìƒì„±í–ˆìœ¼ë‚˜ ì €ìž¥í•  Storageê°€ ì—†ëŠ” ê²ƒì€ ëª…ë°±í•œ ì„¤ì • ì˜¤ë¥˜(ë²„ê·¸)ìž…ë‹ˆë‹¤.
			// ê°œë°œ ë‹¨ê³„ì—ì„œ ê²€ì¶œë˜ì–´ì•¼ í•  ë¬¸ì œì´ë‚˜, ë§Œì•½ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë°œìƒí•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬
			// ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ë¥¼ ì•Œë¦¬ê³  ìš´ì˜ìžê°€ ì‹ ì†ížˆ ì¸ì§€í•  ìˆ˜ ìžˆë„ë¡ ë¡œê·¸ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.
			notifyMsg := b.formatTaskErrorMessage(errMsgStorageNotInitialized)
			if len(message) > 0 {
				notifyMsg = fmt.Sprintf("%s\n\n[ìž‘ì—… ì‹¤í–‰ ê²°ê³¼ ìƒì„¸]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n%s", notifyMsg, message)
			}

			b.Log(component, applog.ErrorLevel, "ìŠ¤ëƒ…ìƒ· ì €ìž¥ ì‹¤íŒ¨: Storage ì˜ì¡´ì„± ëˆ„ë½", nil, applog.Fields{
				"notification_message": notifyMsg,
			})

			b.sendErrorNotification(ctx, notificationSender, notifyMsg)

			return
		}
	}

	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// 3ë‹¨ê³„: ì„±ê³µ ì•Œë¦¼ ì „ì†¡
	// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
	// ëª¨ë“  ê³¼ì •(execute ì‹¤í–‰, Snapshot ì €ìž¥)ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ ì‚¬ìš©ìžì—ê²Œ ì„±ê³µ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
	//
	// messageê°€ ë¹„ì–´ìžˆëŠ” ê²½ìš°ëŠ” executeê°€ ì˜ë„ì ìœ¼ë¡œ ì•Œë¦¼ì„ ìƒëžµí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì—¬
	// ì•Œë¦¼ì„ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: ë³€ê²½ ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°)
	if len(message) > 0 {
		// ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ëŠ” ë¡œê·¸ë¡œë§Œ ê¸°ë¡í•˜ê³  Task ì‹¤í–‰ ìžì²´ëŠ” ì„±ê³µìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
		// ì´ëŠ” "ì•Œë¦¼ ì‹¤íŒ¨ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤íŒ¨ë¡œ ì „íŒŒë˜ì§€ ì•Šë„ë¡" í•˜ëŠ” ì„¤ê³„ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤.
		if notifyErr := notificationSender.Notify(context.WithoutCancel(ctx), b.newNotification(message, false)); notifyErr != nil {
			b.Log(component, applog.ErrorLevel, "ì„±ê³µ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ì „ì†¡ ì—ëŸ¬", notifyErr, nil)
		}
	}
}

// sendErrorNotification ìž‘ì—… ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ì—ëŸ¬ë¥¼ ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¼ìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
//
// ì´ ë©”ì„œë“œëŠ” Task ì‹¤í–‰ ê³¼ì •ì—ì„œ ë°œìƒí•œ ë‹¤ì–‘í•œ ì—ëŸ¬ ìƒí™©(ì´ˆê¸°í™” ì‹¤íŒ¨, ìŠ¤í¬ëž˜í•‘ ì‹¤íŒ¨, ì €ìž¥ ì‹¤íŒ¨ ë“±)ì„
// ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¬ê¸° ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. Baseì— ë°”ì¸ë”©ëœ ë©”íƒ€ë°ì´í„°(TaskID, CommandID, Elapsed ë“±)ë¥¼
// í¬í•¨í•œ ì—ëŸ¬ ì•Œë¦¼ ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , NotificationSenderë¥¼ í†µí•´ ì „ì†¡í•©ë‹ˆë‹¤.
//
// ì•Œë¦¼ ì „ì†¡ ìžì²´ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ Task ì‹¤í–‰ íë¦„ì„ ì¤‘ë‹¨í•˜ì§€ ì•Šìœ¼ë©°, ëŒ€ì‹  ì—ëŸ¬ ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ì—¬
// ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤. ì´ëŠ” "ì•Œë¦¼ ì‹¤íŒ¨ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤íŒ¨ë¡œ ì „íŒŒë˜ì§€ ì•Šë„ë¡" í•˜ëŠ” ì„¤ê³„ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤.
//
// ë§¤ê°œë³€ìˆ˜:
//   - ctx: ì•Œë¦¼ ì „ì†¡ ìš”ì²­ì˜ ì»¨í…ìŠ¤íŠ¸ (íƒ€ìž„ì•„ì›ƒ, ì·¨ì†Œ ì‹ í˜¸ ì „íŒŒ ìš©ë„)
//   - notificationSender: ì•Œë¦¼ ì „ì†¡ì„ ë‹´ë‹¹í•˜ëŠ” ì¸í„°íŽ˜ì´ìŠ¤ êµ¬í˜„ì²´
//   - message: ì‚¬ìš©ìžì—ê²Œ ì „ë‹¬í•  ì—ëŸ¬ ë©”ì‹œì§€ ë³¸ë¬¸
func (b *Base) sendErrorNotification(ctx context.Context, notificationSender contract.NotificationSender, message string) {
	if err := notificationSender.Notify(context.WithoutCancel(ctx), b.newNotification(message, true)); err != nil {
		b.Log(component, applog.ErrorLevel, "ì—ëŸ¬ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ì „ì†¡ ì—ëŸ¬", err, nil)
	}
}

// newNotification Baseì˜ ìƒíƒœ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒˆë¡œìš´ Notification ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
//
// ì´ ë©”ì„œë“œëŠ” Task ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ì´ë²¤íŠ¸(ì„±ê³µ, ì‹¤íŒ¨, íŒ¨ë‹‰ ë“±)ë¥¼ ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¬ê¸° ìœ„í•œ
// Notification êµ¬ì¡°ì²´ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. Baseì— ë°”ì¸ë”©ëœ ì‹ë³„ìž(TaskID, CommandID ë“±)ì™€
// ì‹¤í–‰ ë©”íƒ€ë°ì´í„°(Elapsed)ë¥¼ ìžë™ìœ¼ë¡œ í¬í•¨í•˜ì—¬ ì¼ê´€ëœ ì•Œë¦¼ í˜•ì‹ì„ ë³´ìž¥í•©ë‹ˆë‹¤.
//
// ë§¤ê°œë³€ìˆ˜:
//   - message: ì‚¬ìš©ìžì—ê²Œ ì „ë‹¬í•  ì•Œë¦¼ ë©”ì‹œì§€ ë³¸ë¬¸
//   - errorOccurred: ì—ëŸ¬ ë°œìƒ ì—¬ë¶€ (true: ì‹¤íŒ¨ ì•Œë¦¼, false: ì„±ê³µ ì•Œë¦¼)
func (b *Base) newNotification(message string, errorOccurred bool) contract.Notification {
	return contract.Notification{
		NotifierID: b.NotifierID(),

		TaskID:     b.ID(),
		CommandID:  b.CommandID(),
		InstanceID: b.InstanceID(),

		Message: message,
		Elapsed: b.Elapsed(),

		ErrorOccurred: errorOccurred,
		Cancelable:    false,
	}
}

// formatTaskErrorMessage ìž‘ì—… ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìžì—ê²Œ ì „ì†¡í•  ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
//
// ì´ ë©”ì„œë“œëŠ” ëª¨ë“  Task ì‹¤í–‰ ì—ëŸ¬ì— ëŒ€í•´ ì¼ê´€ëœ í˜•ì‹ì˜ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
// ê³µí†µ ì—ëŸ¬ í—¤ë”(notifyTaskExecutionFailed)ì— êµ¬ì²´ì ì¸ ì‹¤íŒ¨ ì›ì¸(reason)ì„ ê²°í•©í•˜ì—¬,
// ì‚¬ìš©ìžê°€ ë¬¸ì œë¥¼ ì‰½ê²Œ íŒŒì•…í•  ìˆ˜ ìžˆë„ë¡ í•©ë‹ˆë‹¤.
//
// ë§¤ê°œë³€ìˆ˜:
//   - reason: ìž‘ì—… ì‹¤íŒ¨ì˜ êµ¬ì²´ì ì¸ ì›ì¸ (ë¬¸ìžì—´ ë˜ëŠ” error ê°ì²´)
//
// ë°˜í™˜ê°’:
//   - string: ê³µí†µ í—¤ë”ì™€ ì‹¤íŒ¨ ì›ì¸ì´ ê²°í•©ëœ ìµœì¢… ì—ëŸ¬ ë©”ì‹œì§€
func (b *Base) formatTaskErrorMessage(reason any) string {
	return fmt.Sprintf("%s\n\nâ˜‘ %s", notifyTaskExecutionFailed, reason)
}

// Log ì»´í¬ë„ŒíŠ¸ ì´ë¦„, ì—ëŸ¬, ì¶”ê°€ í•„ë“œë¥¼ í¬í•¨í•œ êµ¬ì¡°ì  ë¡œê¹…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
//
// ì´ ë©”ì„œë“œëŠ” Base ìƒì„± ì‹œ ë°”ì¸ë”©ëœ ê¸°ë³¸ í•„ë“œ(task_id, command_id ë“±)ì—
// ì¶”ê°€ì ì¸ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë§ë¶™ì—¬ ë¡œê·¸ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
func (b *Base) Log(component string, level applog.Level, message string, err error, fields applog.Fields) {
	entry := b.logger.WithField("component", component)
	if err != nil {
		entry = entry.WithError(err)
	}
	if len(fields) > 0 {
		entry = entry.WithFields(fields)
	}
	entry.Log(level, message)
}
